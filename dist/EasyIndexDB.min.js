!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).EasyIndexDB=t()}(this,function(){"use strict";var t=(e.prototype.parserSQL=function(e){for(var t=e.toString().trim().toLowerCase(),r=[],s=[],n=this.handleSingleQuoSpace(t),o=0,a=n.length;o<a;o+=1){var c=n[o],i=0,u=c.length;if(c){for(;i<u;i+=1){var l=c.charAt(i);if("'"===l||'"'===l){var h="",f=i+1;for(i++;i<c.length&&l!==(h=c.charAt(i));)i++;var d=c.substring(f,i);s.push(d)}else if(/^[a-z_]+$/i.test(l)||/^[0-9_]+$/i.test(l)||/^\*/i.test(l)){h="";for(var p=c.charAt(i);i<c.length;){if(i++,h=c.charAt(i),!/^[\w\.:]+$/i.test(h)){i--;break}p+=h}s.push(p)}}var b={cmd:s.shift(),other:JSON.parse(JSON.stringify(s))};s=[],r.push(b)}}return JSON.parse(JSON.stringify(r))},e.prototype.tokenStart=function(e){},e.prototype.tokenEnd=function(e){},e.prototype.handleAllEnd=function(){},e.prototype.handleSingleQuoSpace=function(e){var t=e.split(";");return 0<=t.length?t.map(function(e){return e.trim()}):t},e);function e(){}var a,r,l,s,c=(n.parserUseSql=function(e,t){var r={dbName:e.other.shift(),version:t};return{cmd:e.cmd,use:r}},n);function n(){}(r=a=a||{}).Use="use",r.Create="create",r.Select="select",r.Update="update",r.Insert="insert",r.Delete="delete",(s=l=l||{}).Success="2000",s.Error="20001";var i=(o.parserTableSql=function(e){e.other.shift();var t=e.cmd,r=e.other.shift(),s=new Map;return e.other.forEach(function(e,t,r){s.set(e,e)}),{cmd:t,table:{tableName:r,column:s}}},o);function o(){}function h(e,t){if(Array.isArray(t))for(var r=0,s=t.length;r<s;r+=1)if(e===t[r])return 1;return n=t,!("[object DOMStringList]"!==toString.call(n)||!t.contains(e));var n}var u=(f.prototype.executeUse=function(e,t){var s=this,r=e.use.version,n=e.use.dbName;this.dbMessage.dbName=n,this.request=indexedDB.open(n,r);var o=t;this.request.onerror=function(){var e={code:l.Error,data:""};o(e)},this.request.onsuccess=function(e){console.log("db open success"),s.db=e.target.result,s.state=!0,s.task.forEach(function(e,t,r){s[e.fun](e.param.i,e.param.cb)}),console.log("requestSuccess:",e);var t={code:l.Success,data:""};o(t)},this.request.onupgradeneeded=this.onupgradeneeded.bind(this)},f.prototype.executeTable=function(e,t){e.table.tableName,e.table.column,this.managerObj.push({tgt:e,cb:t})},f.prototype.executeInsert=function(e,t){if(this.checkState()){var s,r=e.insert.tableName,n=e.insert.column,o=this.db.transaction([r],"readwrite").objectStore(r),a=(s={},n.forEach(function(e,t,r){s[t]=e}),s);console.log("executeInsert:",a);var c=t;try{var i=o.add(a);i.onsuccess=function(){console.log("xxx",c);var e={code:l.Success,data:""};c(e)},i.onerror=function(){var e={code:l.Error,data:""};c(e)}}catch(e){var u={code:l.Error,data:e};c(u)}}else this.task.push({fun:"executeInsert",param:{i:e,cb:t}})},f.prototype.executeSelect=function(e,t){if(this.checkState()){var r=e.select.tableName,s=e.select.where;console.error("where.size:",s.size),0<s.size?this.selectWhereFromTable(r,s,t):this.selectAllFromTable(r,t)}else this.task.push({fun:"executeSelect",param:{i:e,cb:t}})},f.prototype.selectWhereFromTable=function(e,t,o){var a=this.getObjectStore(e,"readwrite");t.forEach(function(e,t,r){var s=a.index(t).openCursor(),n=[];s.onsuccess=function(e){var t=e.target.result;if(t)a.getKey(t.key).onsuccess=function(e){var t=e.target.result;n.push(t)},t.continue();else{var r={code:l.Success,data:n};o(r)}}})},f.prototype.selectAllFromTable=function(e,s){var n=this.getObjectStore(e,"readwrite"),t=n.openCursor(),o=[];t.onsuccess=function(e){var t=e.target.result;if(t)n.get(t.key).onsuccess=function(e){var t=e.target.result;o.push(t)},t.continue();else{var r={code:l.Success,data:o};s(r)}}},f.prototype.getObjectStore=function(e,t){return this.db.transaction(e,t).objectStore(e)},f.prototype.checkState=function(){return this.state},f.prototype.onupgradeneeded=function(e){var c=this;console.log("requestUpgradeneeded, event:",e);var t=e.oldVersion,r=e.oldVersion,i=e.target.result,u=i.objectStoreNames;this.dbMessage.oldVersion=t,this.dbMessage.newVersion=r,this.dbMessage.objectStoreNames=u,console.log("dbMessage:",this.dbMessage),this.managerObj.forEach(function(e,t,r){var s=e.tgt.table,n=e.cb,o=s.tableName,a=s.column;h(o,u)?(console.log("has table:",o),n({code:l.Success,data:""})):(c.createTable(i,o,a,n),console.log("do not has talbe:",o))})},f.prototype.updateTable=function(){},f.prototype.createTable=function(e,t,r,s){var n=e.createObjectStore(t,{keyPath:"id",autoIncrement:!0});r.forEach(function(e,t){n.createIndex(e,e,{unique:!1})}),s({code:l.Success,data:""})},f);function f(){this.version=0,this.dbName="",this.managerObj=[],this.task=[],this.state=!1,this.dbMessage={dbName:"",oldVersion:0,newVersion:0,objectStoreNames:[]}}var d=(p.parseInsertSql=function(e,t){var r=e.cmd,s=e.other,n=[],o=[],a=t,c=new Map,i=!1;s.shift();var u=s.shift();return s.forEach(function(e,t,r){"values"!==e?i?"slot"===e?o.push(a.shift()):o.push(e):n.push(e):i=!0}),n.forEach(function(e,t,r){c.set(e,o[t])}),{cmd:r,insert:{tableName:u,column:c}}},p);function p(){}var b=(g.parserSelectSql=function(s){s.other.shift(),s.other.shift();var e=s.cmd,t=(s.other,s.other.shift()),n=new Map;return 0<s.other.length&&s.other.shift(),console.log("selectgrammar:",s.other),s.other.forEach(function(e,t,r){"and"!==e&&t%2==0&&n.set(e,s.other[t+1])}),{cmd:e,select:{tableName:t,where:n}}},g);function g(){}var v=(m.prototype.execute=function(e,t){var r,s=this,n="";r=e,"[object Array]"===toString.call(r)?(n=e.shift(),e.forEach(function(e,t,r){s.slotQue.push(e)})):n=e,this.cbQue=this.cbQue.concat(t);var o=this.sqlLexter.parserSQL(n);console.log("afterSqlLexter:",JSON.stringify(o)),o.forEach(this.handleLexter.bind(this))},m.prototype.handleLexter=function(e,t,r){var s=e.cmd,n=this.cbQue.shift(),o=null;switch(console.error("sqlKey:",s),s){case a.Use:o=c.parserUseSql(e,this.version),this.dbManager.executeUse(o,n);break;case a.Create:o=i.parserTableSql(e),this.dbManager.executeTable(o,n);break;case a.Insert:o=d.parseInsertSql(e,this.slotQue),this.dbManager.executeInsert(o,n);break;case a.Delete:break;case a.Select:o=b.parserSelectSql(e),this.dbManager.executeSelect(o,n);break;case a.Update:break;default:console.error("sqlKey is not defined")}},m);function m(e){this.sqlLexter=null,this.dbManager=null,this.slotQue=[],this.cbQue=[],this.version=0,this.version=e,this.sqlLexter=new t,this.dbManager=new u}var S=new v(19);return S.execute("\n  use DB_test;\n\n  create table pdfTable\n  (\n    pdfUrl,\n    pdfData,\n    pdfMd5,\n  );\n",[function(){},function(){}]),S.execute("select * from pdfTable where pdfUrl='https://wwww.baidi.com/2.pdf'",[function(e){console.error(e)}]),v});
